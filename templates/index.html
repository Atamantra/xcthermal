<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-83QR773B3W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-83QR773B3W');
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>XcThermal | AI Paragliding Weather & Thermal Maps</title>
    <meta name="description"
        content="Advanced paragliding weather forecasts, thermal maps, and AI-powered flight condition analysis. Plan your XC flights with precision using Open-Meteo and Meteoblue data." />
    <meta name="keywords"
        content="paragliding weather, thermal map, xc flying, flight forecast, meteogram, paragliding thermals, hike and fly, weather ai" />
    <meta name="author" content="XcThermal" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://xcthermal.com" />

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://xcthermal.com">
    <meta property="og:title" content="XcThermal - AI Powered Paragliding Weather" />
    <meta property="og:description"
        content="Get AI-powered thermal predictions, 3D mapping, and personalized flight reports.">
    <meta property="og:image" content="{{ url_for('static', filename='social_card.png') }}?v=1">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://xcthermal.com/" />
    <meta name="twitter:title" content="XcThermal | AI Paragliding Weather & 3D Maps">
    <meta name="twitter:description" content="Plan your next XC flight with AI insights and interactive 3D maps.">
    <meta name="twitter:image" content="{{ url_for('static', filename='social_card.png') }}?v=1">

    <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "XcThermal",
    "operatingSystem": "Web",
    "applicationCategory": "SportsApplication",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "description": "A paragliding weather application providing thermal maps and AI-assisted flight forecasts.",
    "author": {
        "@type": "Person",
        "name": "Ataberk DoÄŸanlÄ±"
    }
  }
  </script>

    <!-- Favicon Integration -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}?v=6" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}?v=6">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}?v=6">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}?v=6">

    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css">
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='antigravity.css') }}">

</head>

<body>

    <!-- ANTIGRAVITY PRELOADER -->
    <div id="antigravity-preloader">
        <div class="stars"></div>
        <div class="hamster-scene">
            <div class="wheel"></div>
            <div class="hamster">
                <div class="hamster-body"></div>
                <div class="hamster-head">
                    <div class="hamster-ear"></div>
                    <div class="hamster-ear right"></div>
                    <div class="hamster-eye"></div>
                    <div class="hamster-eye left"></div>
                </div>
                <!-- Limbs -->
                <div class="hamster-limb fl"></div>
                <div class="hamster-limb fr"></div>
                <div class="hamster-limb bl"></div>
                <div class="hamster-limb br"></div>
                <!-- Helmet -->
                <div class="space-helmet"></div>
            </div>
        </div>
        <div class="text">XCTHERMAL</div>
        <div class="subtext">FORCING HAMSTERS TO RUN ...</div>
    </div>

    <header>
        <nav class="main-nav">
            <a href="/">Home</a>
            {% if current_user.is_authenticated %}
            <span class="user-info" onclick="document.getElementById('addCreditsModalOverlay').classList.add('active')">
                <img src="{{ url_for('static', filename='hamster_coin.png') }}" class="hamster-icon" alt="Credits">
                <span id="userCreditsSpan" class="credits">{{ current_user.credits }}</span>
            </span>
            <a href="#" id="navProfileBtn">Profile</a>
            <a href="{{ url_for('logout') }}">Logout</a>
            {% else %}
            <a href="#" id="navLoginBtn">Login</a>
            <a href="#" id="navRegisterBtn">Register</a>
            {% endif %}
        </nav>
    </header>

    <div id="map"></div>

    <div id="mapLogoContainer">
        <a href="/" id="mapLogoLink">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="XC Thermal Logo" id="mapLogo" />
        </a>
    </div>

    <div id="flash-messages-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">
            {{ message }}
            <span class="close-btn" onclick="this.parentElement.style.display='none';">&times;</span>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>
    <button id="searchToggleBtn" title="Search">
        <img src="{{ url_for('static', filename='search.png') }}" alt="Search" />
    </button>
    <div id="searchWrapper" style="display: none;">
        <div id="searchPanel">
            <div id="geocoder-container"></div>
            <button id="historyToggle">History</button>
            <ul id="historyList" class="hidden"></ul>
            <div id="weatherBox" class="hidden"></div>
        </div>
    </div>
    <button id="statsButton" class="statsIcon" title="Statistics">
        <img src="{{ url_for('static', filename='stats.png') }}" alt="Stats" />
    </button>
    <button id="tutorialBtn" title="Restart Tutorial">?</button>
    <button id="creditsBtn" title="Credits & Info"
        onclick="document.getElementById('welcomeModalOverlay').classList.add('active')">i</button>

    <button id="calculatorBtn" title="Distance & Triangle Calculator">
        <img src="{{ url_for('static', filename='triangle1.png') }}" alt="Calculator" />
    </button>

    <div id="calculatorPanel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; font-size:16px;">XC Calculator</h3>
            <button id="closeCalculatorBtn"
                style="background:none; border:none; font-size:18px; cursor:pointer;">&times;</button>
        </div>
        <div id="calculatorResult" style="font-size:14px; margin-bottom:15px; min-height:40px;">
            <p style="text-align:center; color:#777;">Click map to add Start/Turnpoints</p>
        </div>

        <input type="file" id="trackUploadInput" accept=".igc,.gpx,.kml" style="display: none;" />
        <button id="uploadTrackBtn"
            style="width: 100%; margin-bottom: 8px; padding: 8px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
            ðŸ“‚ Upload Flight Record
        </button>

        <button id="clearCalculatorBtn"
            style="width:100%; padding:8px; background:#f44336; color:white; border:none; border-radius:6px; cursor:pointer;">Clear
            Points</button>
    </div>

    <button id="settingsBtn" class="settings-icon" title="Settings">
        <img src="{{ url_for('static', filename='settings.png') }}" alt="Settings" />
    </button>

    <div id="settingsPanel" class="settings-panel">
        <button id="closeSettingsBtn" class="close-btn" title="Close Settings">Ã—</button>
        <h2 id="settingsTitle">Settings</h2>
        <div class="setting-group">
            <label for="languageSelect" id="labelLanguage">Language:</label>
            <select id="languageSelect">
                <option value="en">English</option>
                <option value="tr">TÃ¼rkÃ§e</option>
                <option value="es">EspaÃ±ol</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="unitSelect" id="labelUnits">Units:</label>
            <select id="unitSelect">
                <option value="metric">Metric (m/km/Â°C)</option>
                <option value="imperial">Imperial (ft/mi/Â°F)</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="aiPromptStyle" id="labelStyle">AI Prompt Style:</label>
            <select id="aiPromptStyle">
                <option value="basic">Basic</option>
                <option value="pilot">Pilot</option>
                <option value="xc">XC</option>
                <option value="tandem">Tandem Pilot</option>
                <option value="expert">Expert Level</option>
                <option value="speed">Speed Flight</option>
                <option value="acro">Acro Flight</option>
                <option value="ridge">Ridge Soaring</option>
                <option value="xcperfect">XcPerfect Alert</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="mapStyleSelect" id="labelMapStyle">Map Style:</label>
            <select id="mapStyleSelect">
                <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite</option>
                <option value="mapbox://styles/mapbox/outdoors-v12">Outdoors</option>
                <option value="mapbox://styles/mapbox/streets-v12">Streets</option>
                <option value="mapbox://styles/mapbox/light-v11">Light</option>
                <option value="mapbox://styles/mapbox/dark-v11">Dark</option>
                <option value="mapbox://styles/mapbox/navigation-day-v1">Navigation Day</option>
                <option value="mapbox://styles/mapbox/navigation-night-v1">Navigation Night</option>
            </select>
        </div>
        <div class="setting-group">
            <label id="labelHotspots"
                style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                Hotspots
                <input type="checkbox" id="hotspotCheckbox" style="width: auto; margin-left: 10px;">
            </label>
        </div>

        <!-- Coming Soon Placeholder for KK7 Layers -->
        <div class="setting-group"
            style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px; margin-top: 10px; text-align: center; color: #888; font-style: italic;">
            <p>Advanced thermal layers (Skyways, Thermals, Certainty) - Coming Soon!</p>
        </div>

        <!-- SpotAiR Toggle -->
        <div class="setting-group" style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px; margin-top: 10px;">
            <label id="labelSpotAir"
                style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <span style="font-weight: bold; color: #333;">SpotAiR <span
                        style="color: #ef4444; font-size: 0.8em;">LIVE</span></span>
                <input type="checkbox" id="spotairCheckbox" style="width: auto; margin-left: 10px;">
            </label>
        </div>
    </div>

    {% if current_user.is_authenticated %}
    <button id="aiToggleBtn" class="ai-bounce" title="Interpret Weather">Interpret</button>

    <div id="aiPanel" class="ai-panel">
        <button id="aiCloseBtn" class="ai-close-btn">Ã—</button>
        <h2 class="ai-panel-title">Weather Analysis</h2>

        <!-- Email Report Container (Top) -->
        <div class="email-report-container" style="display: none; margin-bottom: 15px;">
            <p class="email-title">ðŸ“© Save / Send Report</p>

            {% if current_user.is_authenticated and current_user.email %}
            <div class="email-options">
                <label class="email-option-label">
                    <input type="radio" name="emailTargetTop" value="me" checked onchange="toggleEmailInput(this)">
                    Send to Me
                </label>
                <label class="email-option-label">
                    <input type="radio" name="emailTargetTop" value="other" onchange="toggleEmailInput(this)">
                    Send to Other
                </label>
            </div>
            {% endif %}

            <div class="email-input-group">
                <input type="email" class="recipient-email-input" placeholder="Enter email address"
                    value="{{ current_user.email if current_user.is_authenticated else '' }}" {% if
                    current_user.is_authenticated %}disabled{% endif %} />
                <button class="btn-send-email">Send</button>
            </div>
            <p class="email-status-msg"></p>
        </div>

        <script>
            function toggleEmailInput(radio) {
                const container = radio.closest('.email-report-container');
                const emailInput = container.querySelector('.recipient-email-input');
                if (radio.value === 'me') {
                    emailInput.value = "{{ current_user.email }}";
                    emailInput.disabled = true;
                } else {
                    emailInput.value = "";
                    emailInput.disabled = false;
                    emailInput.focus();
                }
            }
        </script>


        <div id="aiOutput" class="ai-output-text">
            Loading interpretation. It May Take Up To 1-2 Minutes.
        </div>




    </div>
    {% endif %}

    <button id="fakeAiToggleBtn" class="ai-bounce" title="Interpret Weather" style="display: none;">Interpret</button>

    <div id="thermalBox" class="collapsed">
        <div id="thermalHeader">Thermal Forecast â–²</div>
        <div id="thermalImageScroll">
            <img id="thermalImage" src="" alt="Thermal forecast will appear here." style="display: none;" />
            <div id="thermalPlaceholder">Click on a location to load the thermal forecast.</div>
        </div>
    </div>

    <div id="imageModal" class="image-modal hidden">
        <span id="modalClose" class="close-btn" role="button" aria-label="Close modal">&times;</span>
        <img id="modalImage" class="modal-content" alt="Enlarged thermal forecast" />
    </div>

    <div id="chartContainer"
        style="display:none; position:fixed; bottom:30px; left:0; width:100%; height:200px; background:rgba(255,255,255,0.9); z-index:999; border-top:1px solid #ccc; padding:10px;">
        <button id="closeChartBtn"
            style="position:absolute; top:5px; right:20px; border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        <canvas id="altitudeChart"></canvas>
    </div>

    <footer id="verticalFooter"> XcThermalÂ©
        <a href="https://www.paraglidingearth.com" target="_blank">ParaglidingEarth</a>,
        <a href="https://thermal.kk7.ch" target="_blank" rel="noopener noreferrer">thermal.kk7.ch</a>
    </footer>

    {% if not current_user.is_authenticated %}
    <div id="authModalOverlay" class="auth-modal-overlay">
        <div id="authModalContent" class="auth-modal-content">
            <h2>Login Required</h2>
            <form method="POST" action="{{ url_for('login') }}">
                <div class="form-group">
                    <label for="modalUsername">Username</label>
                    <input type="text" id="modalUsername" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="modalPassword">Password</label>
                    <input type="password" id="modalPassword" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="modal-login-btn">Log In</button>
            </form>

            <div class="social-login">
                <div class="divider"><span>Or</span></div>
                <a href="{{ url_for('login_google') }}" class="social-btn google-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
                    Sign in with Google
                </a>
                <a href="{{ url_for('login_apple') }}" class="social-btn apple-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple">
                    Sign in with Apple
                </a>
            </div>
            <p class="modal-register-text" style="margin-top: 15px;"><a href="#"
                    onclick="switchModal('authModalOverlay', 'resetPasswordModalOverlay'); return false;">Forgot
                    Password?</a></p>
            <p class="modal-register-text">Don't have an account? <a href="#"
                    onclick="switchModal('authModalOverlay', 'registerModalOverlay'); return false;">Register here</a>
            </p>
        </div>
    </div>
    {% endif %}

    <div id="spotairOverlay" class="spotair-overlay">
        <iframe id="spotairIframe" src="about:blank" width="100%" height="100%" frameborder="0" allow="geolocation">
        </iframe>
    </div>

    <script>
        window.userIsAuthenticated = {{ 'true' if user_authenticated else 'false' }};
        window.userLastState = {{ user_last_state | tojson | safe if user_last_state else 'null' }};
        window.interpretationCost = {{ interpretation_cost }};
        window.userCredits = {{ current_user.credits if current_user.is_authenticated else 0 }};
        window.userTutorialCompleted = {{ 'true' if tutorial_completed else 'false' }};
        window.mapboxToken = "{{ mapbox_token or '' }}";

        function closeProfileModal() {
            document.getElementById('profileModalOverlay').classList.remove('active');
            const userInfo = document.querySelector('.user-info');
            if (userInfo) userInfo.style.display = '';
        }

        // Daily Interpreter Logic
        document.addEventListener('DOMContentLoaded', () => {
            const infoBtn = document.getElementById('info-btn');
            const infoContent = document.getElementById('info-content');
            if (infoBtn && infoContent) {
                infoBtn.addEventListener('click', () => {
                    infoContent.style.display = infoContent.style.display === 'none' ? 'block' : 'none';
                });
            }

            const dailyEmailCheckbox = document.getElementById('dailyEmailEnabled');
            const settingsContainer = document.querySelector('.interpreter-settings');
            if (dailyEmailCheckbox && settingsContainer) {
                dailyEmailCheckbox.addEventListener('change', () => {
                    settingsContainer.style.display = dailyEmailCheckbox.checked ? 'block' : 'none';
                });
            }

            const saveDailyBtn = document.getElementById('save-daily');
            const saveStatus = document.getElementById('save-status');

            // --- Min XC Logic Initialization ---
            const xcToggle = document.getElementById('dailyMinXcToggle');
            const xcInput = document.getElementById('dailyMinXcInput');
            const xcLabel = document.getElementById('minXcUnitLabel');

            function updateXcDisplay() {
                const units = localStorage.getItem('unitSystem') || 'metric';
                const isImperial = units === 'imperial';
                if (xcLabel) xcLabel.textContent = isImperial ? '(mi)' : '(km)';

                if (xcToggle.checked) {
                    xcInput.disabled = false;
                } else {
                    xcInput.disabled = true;
                    xcInput.value = '';
                }
            }

            if (xcToggle && xcInput) {
                // Initialize from data attribute
                const originalKm = parseFloat(xcInput.dataset.originalKm);
                const units = localStorage.getItem('unitSystem') || 'metric';

                if (originalKm && originalKm > 0) {
                    xcToggle.checked = true;
                    if (units === 'imperial') {
                        xcInput.value = (originalKm * 0.621371).toFixed(1);
                    } else {
                        xcInput.value = originalKm;
                    }
                } else {
                    xcToggle.checked = false;
                    xcInput.value = '';
                }
                updateXcDisplay();

                xcToggle.addEventListener('change', updateXcDisplay);

                // Watch text input to ensure we don't save blank as 0 if toggled on? 
                // Mostly just need to watch unit changes
                const unitSelect = document.getElementById('unitSelect');
                if (unitSelect) {
                    unitSelect.addEventListener('change', () => {
                        const newUnits = unitSelect.value;
                        if (xcToggle.checked && xcInput.value) {
                            const val = parseFloat(xcInput.value);
                            if (!isNaN(val)) {
                                if (newUnits === 'imperial') {
                                    // Metric -> Imperial
                                    xcInput.value = (val * 0.621371).toFixed(1);
                                } else {
                                    // Imperial -> Metric (val is miles)
                                    xcInput.value = (val / 0.621371).toFixed(1);
                                }
                            }
                        }
                        updateXcDisplay();
                    });
                }
            }

            if (saveDailyBtn) {
                saveDailyBtn.addEventListener('click', async () => {
                    const dailyEmailEnabled = document.getElementById('dailyEmailEnabled').checked;
                    const dailyTakeoffDirections = document.getElementById('dailyTakeoffDirections').value;
                    const dailyAiStyle = document.getElementById('dailyAiStyle').value;
                    const dailyAutoRoute = document.getElementById('dailyAutoRoute').checked;

                    // Handle Min XC
                    let dailyMinXcKm = null;
                    if (document.getElementById('dailyMinXcToggle').checked) {
                        const val = parseFloat(document.getElementById('dailyMinXcInput').value);
                        if (!isNaN(val)) {
                            const units = localStorage.getItem('unitSystem') || 'metric';
                            dailyMinXcKm = (units === 'imperial') ? (val / 0.621371) : val;
                        }
                    }

                    // Handle XcPerfect Location
                    const xcLat = document.getElementById('xcLat').value;
                    const xcLon = document.getElementById('xcLon').value;
                    const xcAsl = document.getElementById('xcAsl').value;

                    try {
                        const response = await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dailyEmailEnabled,
                                dailyTakeoffDirections,
                                dailyMinXcKm,
                                dailyAiStyle,
                                dailyAutoRoute,
                                xcPerfectLat: xcLat,
                                xcPerfectLon: xcLon,
                                xcPerfectAsl: xcAsl
                            })
                        });
                        if (response.ok) {
                            saveStatus.style.opacity = '1';
                            setTimeout(() => { saveStatus.style.opacity = '0'; }, 3000);
                        } else { alert('Failed to save settings.'); }
                    } catch (e) { console.error(e); alert('Error saving settings.'); }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const messages = document.querySelectorAll('.flash-message');
            messages.forEach(msg => {
                setTimeout(() => {
                    msg.style.opacity = '0';
                    msg.style.transform = 'translateY(-20px)';
                    setTimeout(() => { msg.remove(); }, 500);
                }, 4000);
            });
        });
    </script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}?v=9"></script>
    <script type="module" src="{{ url_for('static', filename='js/services/autoMail.js') }}"></script>


    <div id="tutorialOverlay" class="tutorial-overlay" style="display: none;">
        <div class="tutorial-modal">
            <h2 id="tutorialTitle">Welcome to XcThermal!</h2>
            <p id="tutorialText">Let's take a quick tour to show you around.</p>
            <div class="tutorial-navigation">
                <button id="tutorialSkipBtn" class="tutorial-btn secondary">Skip Tour</button>
                <button id="tutorialPrevBtn" class="tutorial-btn" style="display: none;">Previous</button>
                <button id="tutorialNextBtn" class="tutorial-btn">Next</button>
                <button id="tutorialDoneBtn" class="tutorial-btn" style="display: none;">Done</button>
            </div>
        </div>
    </div>
    <!-- Profile Modal (Restored Full Version) -->
    {% if current_user.is_authenticated %}
    <div id="profileModalOverlay" class="auth-modal-overlay">
        <div class="profile-container auth-modal-content"
            style="max-height: 85vh; overflow-y: auto; max-width: 800px; width: 90%;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 2em; color: #007BFF;">{{ current_user.username }}</h1>
                <button class="close-btn" onclick="closeProfileModal()"
                    style="color: #333; font-size: 2em; background:none; border:none; cursor:pointer;">&times;</button>
            </div>



            <!-- Flash Messages -->
            <div id="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
                {% endif %}
                {% endwith %}
            </div>

            <div class="profile-user-details">
                <p>Email: <strong>{{ current_user.email }}</strong></p>
                <p>Credits: <strong>{{ current_user.credits }}</strong></p>
                <p>Joined: <strong>{{ current_user.created_at.strftime('%Y-%m-%d') }}</strong></p>
            </div>

            <div class="actions" style="margin: 20px 0; text-align: center;">
                <a href="#" class="modal-login-btn"
                    onclick="closeProfileModal(); document.getElementById('addCreditsModalOverlay').classList.add('active'); return false;">Add
                    Credits</a>
                <a href="{{ url_for('logout') }}" class="modal-login-btn"
                    style="background: #dc3545; margin-left: 10px;">Logout</a>
            </div>

            <!-- Daily Interpreter Section (Moved) -->
            <!-- XcPerfect Section -->
            <!-- Daily Interpreter Section (Redesigned) -->
            <!-- Daily Interpreter Section (Redesigned) -->
            <div class="daily-interpreter-section">
                <div class="section-header">
                    <h2>
                        XcPerfect Alert
                        <div class="info-tooltip-container">
                            <span
                                style="font-size: 0.6em; color: #058ba0; cursor: help; vertical-align: super;">?</span>
                            <div class="info-tooltip-text">
                                <strong>Automatic Daily Interpreter:</strong><br>
                                Sends you an email when the weather conditions are:<br>
                                1. <strong>Suitable for flight</strong> (based on your takeoff face preference).<br>
                                2. <strong>Good for XC</strong> (meets your minimum km requirement).<br>
                                3. <strong>Draws automatic XC route</strong> (Demo/Beta mode).
                            </div>
                        </div>
                    </h2>
                </div>

                <div id="info-content" class="info-content" style="display: none;">
                    <strong>Automatic Daily Interpreter:</strong><br>
                    Sends you an email when the weather conditions are:<br>
                    1. <strong>Suitable for flight</strong> (based on your takeoff face preference).<br>
                    2. <strong>Good for XC</strong> (meets your minimum km requirement).<br>
                    3. <strong>Draws automatic XC route</strong> (Demo/Beta mode).
                </div>

                <form id="daily-interpreter-form">
                    <div class="toggle-wrapper">
                        <label class="switch">
                            <input type="checkbox" id="dailyEmailEnabled" {% if current_user.daily_email_enabled
                                %}checked{% endif %}>
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">Send me an email if weather is XC Perfect!</span>
                    </div>

                    <div class="interpreter-settings"
                        style="display: {% if current_user.daily_email_enabled %}block{% else %}none{% endif %};">

                        <!-- Location Selection Hook -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="margin-bottom: 10px;">Select Location for Analysis:</label>
                            <button type="button" id="select-from-map-btn"
                                style="width: 100%; padding: 12px; background: #058ba0; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; transition: background 0.2s;">
                                Select from Map
                            </button>

                            <!-- Display Saved Location if exists -->
                            <div id="saved-xc-location"
                                style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; display: {% if current_user.xc_perfect_lat %}block{% else %}none{% endif %};">
                                <div style="font-weight: bold; color: #058ba0; font-size: 0.9em; margin-bottom: 5px;">
                                    Saved Location:</div>
                                <div style="display: flex; gap: 15px; font-size: 0.85em; color: #555;">
                                    <span>Lat: <span id="dispXcLat">{{ current_user.xc_perfect_lat }}</span></span>
                                    <span>Lon: <span id="dispXcLon">{{ current_user.xc_perfect_lon }}</span></span>
                                    <span>Alt: <span id="dispXcAsl">{{ current_user.xc_perfect_asl }}</span>m</span>
                                </div>
                            </div>

                            <!-- Hidden inputs for logic (pre-filled with saved data) -->
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div>
                                    <label style="font-size: 0.8em;">Lat</label>
                                    <input type="number" id="xcLat" step="any" placeholder="Lat" class="form-control"
                                        style="padding: 8px;" value="{{ current_user.xc_perfect_lat or '' }}">
                                </div>
                                <div>
                                    <label style="font-size: 0.8em;">Lon</label>
                                    <input type="number" id="xcLon" step="any" placeholder="Lon" class="form-control"
                                        style="padding: 8px;" value="{{ current_user.xc_perfect_lon or '' }}">
                                </div>
                                <div>
                                    <label style="font-size: 0.8em;">Alt (m)</label>
                                    <input type="number" id="xcAsl" step="any" placeholder="Alt" class="form-control"
                                        style="padding: 8px;" value="{{ current_user.xc_perfect_asl or '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="dailyTakeoffDirections">Preferred Takeoff Face</label>
                                <select id="dailyTakeoffDirections" class="form-control">
                                    <option value="" {% if not current_user.daily_takeoff_directions %}selected{% endif
                                        %}>Any
                                    </option>
                                    <option value="N" {% if current_user.daily_takeoff_directions=='N' %}selected{%
                                        endif %}>N
                                    </option>
                                    <option value="NE" {% if current_user.daily_takeoff_directions=='NE' %}selected{%
                                        endif %}>
                                        NE</option>
                                    <option value="E" {% if current_user.daily_takeoff_directions=='E' %}selected{%
                                        endif %}>E
                                    </option>
                                    <option value="SE" {% if current_user.daily_takeoff_directions=='SE' %}selected{%
                                        endif %}>
                                        SE</option>
                                    <option value="S" {% if current_user.daily_takeoff_directions=='S' %}selected{%
                                        endif %}>S
                                    </option>
                                    <option value="SW" {% if current_user.daily_takeoff_directions=='SW' %}selected{%
                                        endif %}>
                                        SW</option>
                                    <option value="W" {% if current_user.daily_takeoff_directions=='W' %}selected{%
                                        endif %}>W
                                    </option>
                                    <option value="NW" {% if current_user.daily_takeoff_directions=='NW' %}selected{%
                                        endif %}>
                                        NW</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dailyAiStyle">Daily Alert Style</label>
                                <select id="dailyAiStyle" class="form-control">
                                    <option value="basic" {% if current_user.daily_ai_style=='basic' %}selected{% endif
                                        %}>Basic
                                    </option>
                                    <option value="pilot" {% if current_user.daily_ai_style=='pilot' %}selected{% endif
                                        %}>Pilot
                                    </option>
                                    <option value="xc" {% if current_user.daily_ai_style=='xc' %}selected{% endif %}>XC
                                    </option>
                                    <option value="tandem" {% if current_user.daily_ai_style=='tandem' %}selected{%
                                        endif %}>
                                        Tandem Pilot</option>
                                    <option value="expert" {% if current_user.daily_ai_style=='expert' %}selected{%
                                        endif %}>
                                        Expert Level</option>
                                    <option value="speed" {% if current_user.daily_ai_style=='speed' %}selected{% endif
                                        %}>Speed
                                        Flight</option>
                                    <option value="acro" {% if current_user.daily_ai_style=='acro' %}selected{% endif
                                        %}>Acro
                                        Flight</option>
                                    <option value="ridge" {% if current_user.daily_ai_style=='ridge' %}selected{% endif
                                        %}>Ridge
                                        Soaring</option>
                                    <option value="xcperfect" {% if current_user.daily_ai_style=='xcperfect'
                                        %}selected{% endif %}>XcPerfect Alert</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <label for="dailyMinXcInput">Min XC Distance <span
                                            id="minXcUnitLabel">(km)</span></label>
                                    <label class="switch" style="transform: scale(0.8); margin: 0;">
                                        <input type="checkbox" id="dailyMinXcToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <input type="number" id="dailyMinXcInput" class="form-control"
                                    data-original-km="{{ current_user.daily_min_xc_km or '' }}" placeholder="" disabled>
                            </div>
                        </div>

                        <div class="auto-route-group">
                            <input type="checkbox" id="dailyAutoRoute" {% if current_user.daily_auto_route %}checked{%
                                endif %}>
                            <label for="dailyAutoRoute" style="margin:0; cursor:pointer;">Draw automatic XC route
                                (Demo)</label>
                        </div>

                        <button type="button" id="save-daily" class="save-btn">Save Preferences</button>
                        <span id="save-status" style="opacity: 0; transition: opacity 0.5s;">Saved
                            Successfully!</span>
                    </div>
                </form>
            </div>

            <script>
                // XcPerfect Map Selection Logic
                document.getElementById('select-from-map-btn').addEventListener('click', function (e) {
                    e.preventDefault();
                    if (!window.currentMap) {
                        alert('Map not initialized yet.');
                        return;
                    }

                    // Hide modal
                    document.getElementById('profileModalOverlay').classList.remove('active');

                    // Add heartbeat frame
                    const frame = document.createElement('div');
                    frame.className = 'heartbeat-frame';
                    document.body.appendChild(frame);
                    document.body.classList.add('cursor-crosshair');

                    // Disable normal map click
                    if (typeof window.isXcPerfectSelecting !== 'undefined') {
                        window.isXcPerfectSelecting = true;
                    }

                    // Mapbox GL click listener
                    window.currentMap.once('click', async function (evt) {
                        const { lng, lat } = evt.lngLat;

                        // Try to get elevation (async via API)
                        let elevation = 0;
                        if (window.fetchAltitude) {
                            const fetchedAlt = await window.fetchAltitude(lat, lng);
                            if (fetchedAlt !== null) elevation = fetchedAlt;
                        }

                        // Show Confirmation
                        if (window.showXcPerfectConfirm) {
                            window.showXcPerfectConfirm((confirmed) => {
                                frame.remove();
                                document.body.classList.remove('cursor-crosshair');
                                document.getElementById('profileModalOverlay').classList.add('active');

                                if (confirmed) {
                                    document.getElementById('xcLat').value = lat.toFixed(5);
                                    document.getElementById('xcLon').value = lng.toFixed(5);
                                    document.getElementById('xcAsl').value = Math.round(elevation);
                                }
                            });
                        } else {
                            // Fallback if not loaded
                            document.getElementById('xcLat').value = lat.toFixed(5);
                            document.getElementById('xcLon').value = lng.toFixed(5);
                            document.getElementById('xcAsl').value = Math.round(elevation);
                            frame.remove();
                            document.body.classList.remove('cursor-crosshair');
                            document.getElementById('profileModalOverlay').classList.add('active');
                        }

                        // Re-enable normal map click
                        if (typeof window.isXcPerfectSelecting !== 'undefined') {
                            window.isXcPerfectSelecting = false;
                        }
                    });
                });
            </script>

            <!-- AI Reports -->
            <h1 class="profile-section-title">AI Reports</h1>
            <div class="history-list-container">
                {% if current_user.reports %}
                <ul class="transactions-list" id="ai-reports-list">
                    {% for report in current_user.reports %}
                    <li class="{% if loop.index > 3 %}hidden-report{% endif %}">
                        <span class="timestamp">{{ report.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                        <span class="description"><strong>Location:</strong> {{ report.lat|round(4) }}, {{
                            report.lon|round(4) }}</span>
                        <details>
                            <summary style="cursor: pointer; margin-top: 5px; font-weight: bold; color: #007BFF;">
                                View
                                Details</summary>
                            <div
                                style="background: #eee; padding: 10px; border-radius: 5px; margin-top: 5px; width: 100%; font-size: 0.9em; white-space: normal;">
                                {{ report.content | markdown | safe }}
                            </div>
                        </details>
                    </li>
                    {% endfor %}
                </ul>
                {% if current_user.reports|length > 3 %}
                <button id="show-more-reports-btn" onclick="showMoreReports()">Show More</button>
                <script>
                    function showMoreReports() {
                        const hiddenReports = document.querySelectorAll('#ai-reports-list .hidden-report');
                        let count = 0;
                        hiddenReports.forEach(report => {
                            if (count < 3) {
                                report.classList.remove('hidden-report');
                                count++;
                            }
                        });
                        // Hide button if no more hidden reports
                        if (document.querySelectorAll('#ai-reports-list .hidden-report').length === 0) {
                            document.getElementById('show-more-reports-btn').style.display = 'none';
                        }
                    }
                </script>
                {% endif %}
                {% else %}
                <p class="no-reports-text">No AI reports generated yet.</p>
                {% endif %}
            </div>

            <!-- Split History -->
            <div class="history-split">
                <div class="history-column">
                    <h1 class="profile-section-title">Purchases</h1>
                    <div class="history-list-container">
                        {% if current_user.transactions %}
                        <ul class="transactions-list">
                            {% for transaction in current_user.transactions|sort(attribute='timestamp',
                            reverse=true) %}
                            {% if transaction.amount > 0 %}
                            <li>
                                <span class="timestamp">{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M:%S')
                                    }}</span>
                                <span class="description"><strong>Type:</strong> {{ transaction.type | capitalize }}
                                    -
                                    {{ transaction.description or 'N/A' }}</span>
                                <span class="amount positive">
                                    Amount: +{{ transaction.amount }} credits
                                </span>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p style="color: #666;">No transactions yet.</p>
                        {% endif %}
                    </div>
                </div>
                <!-- Interpretations -->
                <div class="history-column">
                    <h1 class="profile-section-title">Interpretations</h1>
                    <div class="history-list-container">
                        {% if current_user.transactions %}
                        <ul class="transactions-list">
                            {% for transaction in current_user.transactions|sort(attribute='timestamp',
                            reverse=true) %}
                            {% if transaction.amount < 0 %} <li>
                                <span class="timestamp">{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M:%S')
                                    }}</span>
                                <span class="description"><strong>Type:</strong> {{ transaction.type | capitalize }}
                                    -
                                    {{ transaction.description or 'N/A' }}</span>
                                <span class="amount negative">
                                    Amount: {{ transaction.amount }} credits
                                </span>
                                </li>
                                {% endif %}
                                {% endfor %}
                        </ul>
                        {% else %}
                        <p style="color: #666;">No transactions yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    <div id="creditsModalOverlay" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <h2>Insufficient Credits</h2>
            <p>You need at least 1 credit to view the thermal forecast.</p>
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <a href="{{ url_for('add_credits') }}" class="modal-login-btn"
                    style="text-decoration: none; display: inline-block;">Get Credits</a>
                <button class="modal-login-btn" style="background-color: #6c757d;"
                    onclick="document.getElementById('creditsModalOverlay').classList.remove('active')">Close</button>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirmationModalOverlay" class="auth-modal-overlay">
        <div class="auth-modal-content" style="text-align: center; max-width: 400px;">
            <div style="text-align: right;"><button class="close-btn"
                    onclick="document.getElementById('confirmationModalOverlay').classList.remove('active')">&times;</button>
            </div>
            <h2 id="confirmationTitle">Confirm Action</h2>
            <p id="confirmationMessage">Are you sure?</p>
            <div style="margin-top: 20px;">
                <button id="confirmYesBtn" class="modal-login-btn">Yes</button>
                <button class="modal-login-btn" style="background-color: #6c757d; margin-left: 10px;"
                    onclick="document.getElementById('confirmationModalOverlay').classList.remove('active')">No</button>
            </div>
        </div>
    </div>
    <!-- Add Credits Modal -->
    <div id="addCreditsModalOverlay" class="auth-modal-overlay">
        <div class="auth-modal-content" style="text-align: center; max-width: 400px; margin: 0 auto;">
            <div style="text-align: right;"><button class="close-btn"
                    onclick="document.getElementById('addCreditsModalOverlay').classList.remove('active')">&times;</button>
            </div>
            <h2>Add Credits</h2>
            <p style="color: white !important;">Your current credits: <strong>{{ current_user.credits }}</strong>
            </p>
            <form method="POST" action="{{ url_for('add_credits') }}">
                <div class="form-group">
                    <label for="amount">Amount to add</label>
                    <input type="number" id="amount" name="amount" min="1" value="10" required
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.4); background: rgba(255,255,255,0.1); color: white;">
                </div>
                <button type="submit" class="modal-login-btn">Add Credits</button>
            </form>
        </div>
    </div>





    <!-- Register Modal -->
    <div id="registerModalOverlay" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <div style="text-align: right;"><button class="close-btn"
                    onclick="document.getElementById('registerModalOverlay').classList.remove('active')">&times;</button>
            </div>
            <h2>Register</h2>
            <form method="POST" action="{{ url_for('register') }}">
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" name="password" required>
                </div>
                <div class="tos-container">
                    <input type="checkbox" id="tos_agree" name="tos_agree" required>
                    <label for="tos_agree">
                        I agree to the <a href="{{ url_for('terms') }}" target="_blank">Terms</a> & <a
                            href="{{ url_for('privacy') }}" target="_blank">Privacy</a>.
                    </label>
                </div>
                <div class="tos-container">
                    <input type="checkbox" id="waiver_agree" name="waiver_agree" required>
                    <label for="waiver_agree">
                        I accept the <a href="#" onclick="openWaiverText(event)">Flight Safety Waiver</a>.
                    </label>
                </div>
                <button type="submit" class="modal-login-btn">Create Account</button>
            </form>
            <p class="modal-register-text">Already have an account? <a href="#"
                    onclick="switchModal('registerModalOverlay', 'authModalOverlay'); return false;">Log in</a></p>
        </div>
    </div>

    <!-- Read-Only Waiver Modal (For Registration) -->
    <div id="waiverTextModal" class="auth-modal-overlay" style="z-index: 10001;">
        <div class="auth-modal-content" style="max-width: 600px; width: 95%;">
            <div style="text-align: right;"><button class="close-btn"
                    onclick="document.getElementById('waiverTextModal').classList.remove('active')">&times;</button>
            </div>
            <h2 style="color: #dc3545 !important; margin-top: 0;">Flight Safety Waiver</h2>

            <div class="legal-text-box"
                style="background: rgba(255,255,255,0.1); padding: 15px; height: 300px; overflow-y: auto; text-align: left; margin-bottom: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); font-size: 0.9em;">
                <h3 style="margin-top:0; font-size: 1.1em; color: #87CEEB;">1. The "Pilot in Command" Doctrine</h3>
                <p>You acknowledge that you are the sole Pilot in Command (PIC). You agree that the decision to
                    launch, fly, and land is yours alone.</p>

                <h3 style="font-size: 1.1em; color: #87CEEB;">2. Assumption of Significant Risk</h3>
                <p>You acknowledge that paragliding is inherently dangerous. You voluntarily assume all such risks.
                </p>

                <h3 style="font-size: 1.1em; color: #87CEEB;">3. Nature of AI & Experimental Data</h3>
                <p>You understand that the Service uses AI to predict weather. It is NOT a certified aviation
                    meteorological service.</p>

                <h3 style="font-size: 1.1em; color: #87CEEB;">4. Waiver of Liability</h3>
                <p>To the maximum extent permitted by law, you release Ata Travel Ltd from any liability for
                    accidents resulting from your use of the Service.</p>
            </div>

            <button class="modal-login-btn"
                onclick="document.getElementById('waiverTextModal').classList.remove('active')">Close</button>
        </div>
    </div>

    <!-- Login Modal Helper -->
    <script>
        function openWaiverText(e) {
            e.preventDefault();
            document.getElementById('waiverTextModal').classList.add('active');
        }

        document.addEventListener("DOMContentLoaded", () => {
            const loginModalContent = document.querySelector('#authModalOverlay .auth-modal-content');
            if (loginModalContent && !loginModalContent.querySelector('.close-btn')) {
                const closeDiv = document.createElement('div');
                closeDiv.style.textAlign = 'right';
                closeDiv.innerHTML = `<button class="close-btn" onclick="document.getElementById('authModalOverlay').classList.remove('active')">&times;</button>`;
                loginModalContent.prepend(closeDiv);
            }
        });
    </script>
    <!-- Reset Password Modal -->
    <div id="resetPasswordModalOverlay" class="auth-modal-overlay">
        <div class="auth-modal-content">
            <div style="text-align: right;"><button class="close-btn"
                    onclick="document.getElementById('resetPasswordModalOverlay').classList.remove('active')">&times;</button>
            </div>
            <h2>Reset Password</h2>
            <p>Enter your email to receive reset instructions.</p>
            <form method="POST" action="/reset_password_request">
                <div class="form-group">
                    <label for="resetEmail">Email</label>
                    <input type="email" id="resetEmail" name="email" required>
                </div>
                <button type="submit" class="modal-login-btn">Send Reset Link</button>
            </form>
            <p class="modal-register-text"><a href="#"
                    onclick="switchModal('resetPasswordModalOverlay', 'authModalOverlay'); return false;">Back to
                    Login</a></p>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcomeModalOverlay" class="auth-modal-overlay">
        <div id="welcomeContent" class="auth-modal-content" style="text-align: center;">
            <button class="close-btn"
                onclick="document.getElementById('welcomeModalOverlay').classList.remove('active')"
                style="float: right;">&times;</button>
            <h2 style="margin-top: 0;">Welcome to XcThermal <span style="font-size: 0.6em; color: #aaa;">v1.1</span>
            </h2>
            <!-- How it works expandable tab -->
            <div class="how-it-works-container" style="margin: 15px 0 25px 0;">
                <button class="how-it-works-btn" onclick="toggleHowItWorks(this)">
                    How it works <span class="arrow">â–¾</span>
                </button>
                <div id="howItWorksExpanded" class="how-it-works-content" style="display: none;">
                    <div style="padding: 15px; text-align: left; font-size: 0.95em; line-height: 2;">
                        <p style="margin-bottom: 15px;">
                            XcThermal fetches data from
                            <a href="https://open-meteo.com/" target="_blank" class="pill-link meteo">Open-Meteo</a>
                            and
                            <a href="https://www.meteoblue.com/" target="_blank" class="pill-link meteo">Meteoblue</a>.
                        </p>
                        <p style="margin-bottom: 0;">
                            It is interpreted by
                            <a href="https://deepmind.google/technologies/gemini/" target="_blank"
                                class="pill-link gemini">âœ¨ Gemini 3</a>,
                            an AI agent that reads visual meteograms and raw data to give the weather forecast.
                        </p>
                    </div>
                </div>
            </div>

            <script>
                function toggleHowItWorks(btn) {
                    const content = document.getElementById('howItWorksExpanded');
                    const arrow = btn.querySelector('.arrow');
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        arrow.innerHTML = 'â–´';
                        btn.style.background = 'rgba(255,255,255,0.2)';
                    } else {
                        content.style.display = 'none';
                        arrow.innerHTML = 'â–¾';
                        btn.style.background = 'rgba(255,255,255,0.1)';
                    }
                }
            </script>

            <div
                style="margin: 20px 0; text-align: left; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <p style="margin: 5px 0; font-size: 0.95em;"><strong>Credits:</strong> Developed by Ataberk DoÄŸanlÄ±
                </p>
                <p style="margin: 5px 0; font-size: 0.95em;"><strong>Disputes/Contact:</strong> <a
                        href="mailto:info@xcthermal.com" style="color: #87CEEB;">info@xcthermal.com</a></p>
            </div>

            <p style="font-size: 0.9em; color: rgba(255,255,255,0.7); margin-bottom: 25px;">ðŸ’¡ For best 3D
                performance,
                use Google Chrome on desktop.</p>

            <div style="margin: 25px 0;">
                <a href="https://buymeacoffee.com/doganliatag" target="_blank" class="bmc-button"
                    style="display: inline-flex; align-items: center; gap: 10px; background-color: #FFDD00; color: #000000; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-family: 'Cookie', cursive, sans-serif; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s;">
                    <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy me a coffee"
                        style="height: 25px; width: auto;">
                    <span style="font-size: 1.1em; font-family: Arial, sans-serif;">Buy me a coffee</span>
                </a>
            </div>

            <button class="modal-login-btn"
                onclick="document.getElementById('welcomeModalOverlay').classList.remove('active')">Let's Fly!
                ðŸª‚</button>
        </div>
    </div>

    <!-- Safety Waiver Modal -->
    <div id="waiverModalOverlay" class="auth-modal-overlay">
        <div class="auth-modal-content" style="max-width: 600px; width: 95%;">
            <h2 style="color: #dc3545 !important;">Safety Waiver</h2>
            <p class="subtitle" style="font-size: 0.9em; margin-bottom: 15px;">Please review and accept terms to
                continue.</p>

            <div class="legal-text-box"
                style="background: rgba(255,255,255,0.1); padding: 15px; height: 250px; overflow-y: auto; text-align: left; margin-bottom: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); font-size: 0.9em;">
                <h3 style="margin-top:0; font-size: 1.1em; color: #87CEEB;">1. The "Pilot in Command" Doctrine</h3>
                <p>You acknowledge that you are the sole Pilot in Command (PIC). You agree that the decision to
                    launch, fly, and land is yours alone.</p>

                <h3 style="font-size: 1.1em; color: #87CEEB;">2. Assumption of Significant Risk</h3>
                <p>You acknowledge that paragliding is inherently dangerous. You voluntarily assume all such risks.
                </p>

                <h3 style="font-size: 1.1em; color: #87CEEB;">3. Nature of AI & Experimental Data</h3>
                <p>You understand that the Service uses AI to predict weather. It is NOT a certified aviation
                    meteorological service.</p>

                <h3 style="font-size: 1.1em; color: #87CEEB;">4. Waiver of Liability</h3>
                <p>To the maximum extent permitted by law, you release Ata Travel Ltd from any liability for
                    accidents resulting from your use of the Service.</p>


                <form id="waiverForm" method="POST" action="{{ url_for('safety_waiver') }}">
                    <div class="form-group"
                        style="text-align: left; display: flex; align-items: flex-start; gap: 10px;">
                        <input type="checkbox" id="modal_agreement" name="agreement" required
                            style="width: 24px; height: 24px; margin-top: 0; cursor: pointer; accent-color: #dc3545;">
                        <label for="modal_agreement" style="font-size: 1em; line-height: 1.4; color: white !important;">
                            I am a certified pilot, I understand the risks, and I accept this waiver.
                        </label>
                    </div>
                    <button type="submit" class="modal-login-btn"
                        style="background-color: #dc3545; margin-top: 20px;">Confirm & Continue</button>
                </form>
            </div>
        </div>

        <script>
            // Waiver Form AJAX Handling
            document.addEventListener("DOMContentLoaded", () => {
                const waiverForm = document.getElementById('waiverForm');
                if (waiverForm) {
                    waiverForm.addEventListener('submit', function (e) {
                        e.preventDefault(); // STOP default form submission
                        e.stopPropagation();

                        const formData = new FormData(this);
                        const btn = this.querySelector('button[type="submit"]');
                        const originalText = btn.innerText;
                        btn.innerText = "Accepting...";
                        btn.disabled = true;

                        // Append ajax query param to ensure backend knows it's AJAX even if headers fail
                        let fetchUrl = this.action;
                        fetchUrl += (fetchUrl.includes('?') ? '&' : '?') + 'ajax=1';

                        fetch(fetchUrl, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            }
                        })
                            .then(response => {
                                // If redirect (302) happened despite AJAX, handle it manually?
                                // Usually fetch follows redirects automatically.
                                if (response.redirected) {
                                    window.location.href = response.url;
                                    return;
                                }
                                if (response.ok) return response.json();
                                throw new Error('Network response was not ok');
                            })
                            .then(data => {
                                if (data && data.status === 'success') {
                                    document.getElementById('waiverModalOverlay').classList.remove('active');
                                    // Reload page if needed, OR just hide modal. 
                                    // User wanted "popup on same page", implies just hide.
                                } else {
                                    alert((data && data.message) || 'Error processing waiver.');
                                    btn.innerText = originalText;
                                    btn.disabled = false;
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                // Fallback: if AJAX fails hard, maybe reload?
                                alert('Error accepting waiver. Please try again.');
                                btn.innerText = originalText;
                                btn.disabled = false;
                            });
                    });
                }
            });

            function switchModal(hideId, showId) {
                const hideEl = document.getElementById(hideId);
                const showEl = document.getElementById(showId);
                if (hideEl) hideEl.classList.remove('active');
                // Small timeout to ensure transition/paint if needed, but usually instant is fine.
                if (showEl) showEl.classList.add('active');

                if (hideId === 'profileModalOverlay') {
                    const userInfo = document.querySelector('.user-info');
                    if (userInfo) userInfo.style.display = '';
                }
            }



            {% if open_modal == 'register' %}
            document.addEventListener("DOMContentLoaded", () => {
                const regOverlay = document.getElementById('registerModalOverlay');
                if (regOverlay) regOverlay.classList.add('active');
            });
            {% elif open_modal == 'login' %}
            document.addEventListener("DOMContentLoaded", () => {
                const authOverlay = document.getElementById('authModalOverlay');
                if (authOverlay) authOverlay.classList.add('active');
            });
            {% endif %}
        </script>
        <script>
            {% if show_waiver_modal %}
            document.addEventListener("DOMContentLoaded", () => {
                const waiverOverlay = document.getElementById('waiverModalOverlay');
                if (waiverOverlay) {
                    waiverOverlay.classList.add('active');
                }
            });
            {% endif %}
        </script>
</body>

</html>